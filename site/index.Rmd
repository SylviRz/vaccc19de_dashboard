---
title: "COVID-19 Impfungsdaten des RKI"
output: 
  html_document:
    theme: yeti
---



<!-- # ```{r} -->
```{r setup, include=FALSE}
# library(vaccc19de)
library(tidyverse)
library(highcharter)
library(emojifont)

knitr::opts_chunk$set(echo = F, message = F, warning = F)


source("../R/utils.R")

specify_decimal <- function(x, k) trimws(format(round(x, k), nsmall=k))


frie_dat <- read_csv("https://raw.githubusercontent.com/friep/vaccc19de_rki_data/main/data/cumulative_time_series.csv")

rki_dat <- dir("../data/", full.names = T) %>% 
  keep(~str_detect(.x, "csv")) %>% 
  purrr::map_dfr(read_csv) %>% 
  bind_rows(frie_dat) %>% 
  distinct(ts_datenstand, bundesland, .keep_all = T) %>% 
  mutate(day = lubridate::as_date(ts_datenstand)) 

pop_dat <- readRDS("../data/pop_dat.RDS")

rki_dat <- rki_dat %>% 
  left_join(pop_dat) %>% 
  mutate(prozent_geimpft = impfungen_kumulativ/insgesamt*100)


de_dat <- rki_dat %>% 
  group_by(day) %>% 
  summarise(impfungen_kumulativ = sum(impfungen_kumulativ),
            insgesamt = sum(insgesamt)) %>% 
  mutate(prozent_geimpft = impfungen_kumulativ/insgesamt*100) %>% 
  mutate(bundesland = "Deutschland")
  
bundesland_colors <- c(colorspace::qualitative_hcl(16, palette = "Dark 3", rev = T), "#000000")

rki_dat <- rki_dat %>% 
  bind_rows(de_dat)

rki_dat <- rki_dat %>% 
  distinct(bundesland) %>% 
  mutate(colors = bundesland_colors) %>% 
  right_join(rki_dat) %>% 
  mutate(prozent_geimpft_label = specify_decimal(prozent_geimpft, 2)) %>% 
  mutate(impfungen_kumulativ_label = scales::label_number()(impfungen_kumulativ) %>% str_remove_all("\\.0"))

updated_data <- F

if(!(rki_dat %>% nrow == readRDS("../data/rki_dat.RDS") %>% nrow)){
  updated_data <- T
}

saveRDS(rki_dat, file = "../data/rki_dat.RDS")


rki_dat <- rki_dat %>% 
  filter(bundesland != "Deutschland")

latest_dat <- rki_dat %>% 
  dplyr::filter(day==max(day))

prelatest_dat <- rki_dat %>% 
  dplyr::filter(day<max(day)) %>% 
  dplyr::filter(day==max(day))
```



Ziel dieses [Dashboards](https://favstats.github.io/vaccc19de_dashboard/) ist es den Fortschritt von COVID-19 Impfungen in Deutschland zu dokumentieren und visualisieren. 

Die Impfungsdaten werden täglich vom Robert-Koch-Institut (RKI) [auf dieser Seite](https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html) bereitgestellt. Die hier dargestellten Daten wurden mit Hilfe des R packages [vaccc19de](https://github.com/friep/vaccc19de) aufbereitet und können [hier](https://github.com/friep/vaccc19de_rki_data) heruntergeladen werden.

Bevölkerungsdaten für die Bundesländer stammen vom [Statistischen Bundesamt](https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Bevoelkerungsstand/Tabellen/bevoelkerung-nichtdeutsch-laender.html).



Autor: [Fabio Votta](https://github.com/favstats)

<center>

<br>

```{r infobox, fig.align="center", fig.height=1, out.width="100%"}


geimpft_lasttime <- prelatest_dat %>% 
  summarize(impfungen_kumulativ = sum(impfungen_kumulativ)) %>% pull(impfungen_kumulativ)



geimpft <- latest_dat %>% 
  summarize(impfungen_kumulativ = sum(impfungen_kumulativ)) %>% pull(impfungen_kumulativ)

latest_day <- unique(prelatest_dat$day) %>% format.Date("%d.%m.%Y")
current_day <- unique(latest_dat$day) %>% format.Date("%d.%m.%Y")

geimpft <- latest_dat %>% 
  summarize(impfungen_kumulativ = sum(impfungen_kumulativ)) %>% pull(impfungen_kumulativ)

geimpft_lasttime <- geimpft-geimpft_lasttime

pop <- latest_dat %>% 
  summarize(insgesamt = sum(insgesamt)) %>% pull(insgesamt)

prozent <- paste0(specify_decimal(geimpft/pop*100, 2), "%")
prozent_lasttime <- paste0("+", specify_decimal((geimpft_lasttime)/geimpft*100, 2), "%")

geimpft <- scales::label_number()(geimpft)
geimpft_lasttime <- scales::label_number()(geimpft_lasttime) %>% paste0("+", .)



df <- data.frame(
    x = rep(0, 4),
    y = rep(4.5, 4),
    h = rep(2.25, 2),
    w = rep(8.25, 2),
    value = c(geimpft,
             prozent, 
             geimpft_lasttime,
             prozent_lasttime),
    info = c("Anzahl der Impfungen",
             "Prozent der Bevölkerung geimpft",
             glue::glue("Zusätzliche Impfungen (seit {latest_day})"),
             glue::glue("Prozent Wachstum (seit {latest_day})")),
    shape = c(fontawesome("fa-users"),
              fontawesome("fa-percent"),
              fontawesome("fa-plus"),
              fontawesome("fa-line-chart")),
    font_family = c(rep("fontawesome-webfont", 4)),
    color = factor(1:4)
)

colors <- colorspace::qualitative_hcl(palette = "Dark 3", 6)

infobox1 <- df %>% 
  slice(1:2) %>% 
  ggplot(aes(x, y, height = h, width = w, label = info)) +
    geom_tile(aes(fill = color)) +
    geom_text(color = "white", fontface = "bold", size = 10,
              aes(label = value, x = x - 3.9, y = y + 0.5), hjust = 0) +
    geom_text(color = "white", fontface = "bold", size = 3,
              aes(label = info, x = x - 3.9, y = y - 0.75), hjust = 0) +
    coord_fixed() +
    scale_fill_manual(values = colors[c(1,5)]) +
    geom_text(size = 10, aes(label = shape, family = font_family,
                             x = x + 3, y = y + 0.1), alpha = 0.25) +
    theme_void() +
    guides(fill = FALSE) +
  facet_wrap(~info, ncol = 2)  + 
theme(
  panel.background = element_rect(fill = "transparent", color = NA), # bg of the panel
  plot.background = element_rect(fill = "transparent", color = NA),
  strip.background = element_blank(),
  strip.text.x = element_blank()
)

ggsave(filename = "../img/infobox1.png", plot = infobox1,
       height = 1,  bg = "transparent")

infobox2 <-df %>% 
  slice(3:4) %>% 
  mutate(info = fct_relevel(info,
                            glue::glue("Zusätzliche Impfungen (seit {latest_day})"),
                            glue::glue("Prozent Wachstum (seit {latest_day})"))) %>% 
  ggplot(aes(x, y, height = h, width = w, label = info)) +
    geom_tile(aes(fill = color)) +
    geom_text(color = "white", fontface = "bold", size = 10,
              aes(label = value, x = x - 3.9, y = y + 0.5), hjust = 0) +
    geom_text(color = "white", fontface = "bold", size = 3,
              aes(label = info, x = x - 3.9, y = y - 0.75), hjust = 0) +
    coord_fixed() +
    scale_fill_manual(values = colors[3:4]) +
    geom_text(size = 10, aes(label = shape, family = font_family,
                             x = x + 3, y = y + 0.1), alpha = 0.25) +
    theme_void() +
    guides(fill = FALSE) +
    facet_wrap(~info, ncol = 2)  + 
    theme(
      panel.background = element_rect(fill = "transparent", color = NA), # bg of the panel
      plot.background = element_rect(fill = "transparent", color = NA),
      strip.background = element_blank(),
      strip.text.x = element_blank()
    )

ggsave(filename = "../img/infobox2.png", plot = infobox2,
       height = 1,  bg = "transparent")

infobox1
infobox2
```

```{r, results = 'hide'}
if(!updated_data){
  
  library(twitteR)
  
  name <- "MyTotallyAwesomeUniqueApp"
  
  consumer_key <- Sys.getenv("consumer_key")
  
  consumer_secret <- Sys.getenv("consumer_secret")
  
  access_token <- Sys.getenv("token")
  
  access_secret <- Sys.getenv("secret")

  
  tempfile1 <- tempfile()
  tempfile2 <- tempfile()
  

  
  setup_twitter_oauth(consumer_key,consumer_secret,
                            access_token,access_secret)  

  download.file("https://github.com/favstats/vaccc19de_dashboard/raw/main/img/infobox1.png", destfile = tempfile1)
  download.file("https://github.com/favstats/vaccc19de_dashboard/raw/main/img/infobox2.png", destfile = tempfile2)
  

tweet_dat <- latest_dat %>% 
  mutate(differenz_zum_vortag_label = scales::label_number()(differenz_zum_vortag) %>% str_remove_all("\\.0")) %>% 
  mutate(prozent_zum_vortag =  (differenz_zum_vortag)/(impfungen_kumulativ-differenz_zum_vortag)*100) %>% 
  mutate(prozent_zum_vortag_label = specify_decimal(prozent_zum_vortag, 1)) %>% 
  mutate(prozent_geimpft_label = specify_decimal(prozent_geimpft, 1)) %>% 
  mutate(tweet_raw1 = glue::glue("{bundesland_iso}: {prozent_geimpft_label}%")) %>% 
  mutate(tweet_raw2 = glue::glue("{bundesland_iso}: {impfungen_kumulativ_label}")) %>% 

  mutate(tweet_raw3 = glue::glue("{bundesland_iso}: +{differenz_zum_vortag_label}"))  %>% 
  mutate(tweet_raw4 = glue::glue("{bundesland_iso}: +{prozent_zum_vortag_label}%"))

  tweet1 <- tweet_dat %>% 
    summarise(tweet1 = paste0(tweet_raw1, collapse = "\n")) %>% 
    pull(tweet1) %>% 
    paste0(glue::glue("Prozent der Bevölkerung geimpft ({current_day}):\n\n"), .)
  
  tweet2 <- tweet_dat %>% 
    summarise(tweet2 = paste0(tweet_raw2, collapse = "\n")) %>% 
    pull(tweet2) %>% 
    paste0(glue::glue("Bevölkerung geimpft ({current_day}):\n\n"), .)
  
  tweet3 <- tweet_dat %>% 
    summarise(tweet3 = paste0(tweet_raw3, collapse = "\n")) %>% 
    pull(tweet3) %>% 
    paste0(glue::glue("Differenz zum Vortag ({latest_day}):\n\n"), .)
  
  tweet4 <- tweet_dat %>% 
    summarise(tweet4 = paste0(tweet_raw4, collapse = "\n")) %>% 
    pull(tweet4) %>% 
    paste0(glue::glue("Prozent Wachstum seit Vortag ({latest_day}):\n\n"), .)

  twitteR::tweet(text = tweet1, mediaPath = tempfile1, bypassCharLimit = T)
  
  Sys.sleep(10)
  
  twitteR::tweet(text = tweet2, mediaPath = tempfile1, bypassCharLimit = T)

  
  Sys.sleep(10)
  
  twitteR::tweet(text = tweet3, mediaPath = tempfile2, bypassCharLimit = T)
  
  Sys.sleep(10)
  
  twitteR::tweet(text = tweet4, mediaPath = tempfile2, bypassCharLimit = T)

}
```


```{r, results = 'hide'}
gg_bv <- de_dat %>% 
  ggplot(aes(day, impfungen_kumulativ)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  scale_y_continuous(limits = c(0, NA), labels = scales::label_number()) +
  labs(y = "Anzahl Impfungen (kumulativ)\n",
       x = '\nDatum (täglich)', 
       title = "Anzahl der Bevölkerung die COVID-19 Impfung erhalten haben\n",
       caption = "\nQuelle: Robert-Koch Institut. Daten Aufbereitung: Fabio Votta (@favstats).") +
  theme(plot.title = element_text(size = 15, hjust = 0.5))

gg_prz <- de_dat %>% 
  ggplot(aes(day, prozent_geimpft)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  scale_y_continuous(labels = scales::unit_format(suffix = "%", accuracy = 0.01), limits = c(0, NA)) +
  labs(y = "Prozent der Bevölkerung geimpft\n",
       x = '\nDatum (täglich)', 
       title = "Prozent der Bevölkerung die COVID-19 Impfung erhalten haben\n",
       caption = "\nQuelle: Robert-Koch Institut. Daten Aufbereitung: Fabio Votta (@favstats).") +
  theme(plot.title = element_text(size = 15, hjust = 0.5))

ggsave(filename = "../img/prozent-zeit.png", plot = gg_prz,
       width = 6, height = 4)

ggsave(filename = "../img/total-zeit.png", plot = gg_bv,
       width = 6, height = 4)



```


Letzte Datenaktualisierung: `r Sys.time()`

</center>

